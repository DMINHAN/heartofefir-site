<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сердце Эфира: Селлестиал</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;500;600;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #EC4899;
            --accent: #06B6D4;
            --dark: #1e1b4b;
            --darker: #0f0e24;
            --light: #f0f9ff;
            --gray: #94a3b8;
            --border: #334155;
            --gold: #f59e0b;
            --cyber-blue: #00bfff;
            --cyber-purple: #8a2be2;
            --cyber-pink: #ff1493;
            --cyber-red: #ff0000;
            --cyber-yellow: #ffff00;
            --cyber-green: #00ff00;
            --cyber-cyan: #00ffff;
            --cyber-magenta: #ff00ff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 20%);
            z-index: -1;
        }
        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }
        .welcome-screen {
            text-align: center;
            position: relative;
            z-index: 1001;
        }
        .welcome-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            animation: pulse 2s infinite, fadeInOut 3s forwards;
        }
        /* Stars animation */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle var(--duration, 3s) infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        /* Header Styles */
        header {
            background: rgba(30, 27, 75, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }
        .logo {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--gold);
            text-decoration: none;
            text-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
            transition: all 0.3s ease;
        }
        .logo:hover {
            transform: scale(1.05);
            text-shadow: 0 0 25px rgba(245, 158, 11, 0.8);
        }
        /* Menu Button */
        .menu-btn {
            background: none;
            border: none;
            color: var(--light);
            font-size: 2rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .menu-btn:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        /* Chapters Menu */
        .chapters-menu {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            transition: left 0.4s ease;
            z-index: 1000;
            overflow-y: auto;
            border-right: 1px solid var(--primary);
        }
        .chapters-menu.open {
            left: 0;
        }
        .menu-header {
            background: rgba(139, 92, 246, 0.2);
            color: var(--light);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--primary);
        }
        .menu-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        .close-menu {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .close-menu:hover {
            background: rgba(236, 72, 153, 0.2);
            transform: rotate(90deg);
        }
        .menu-content {
            padding: 20px;
        }
        .menu-chapters-list {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(139, 92, 246, 0.3);
        }
        .menu-chapters-list::-webkit-scrollbar {
            width: 8px;
        }
        .menu-chapters-list::-webkit-scrollbar-track {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
        }
        .menu-chapters-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        .menu-chapters-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        /* Hero Section */
        .hero {
            padding: 100px 0 60px;
            text-align: center;
            position: relative;
            opacity: 0;
            animation: fadeIn 1s ease-out 3.5s forwards;
        }
        .hero h1 {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
            animation: fadeInUp 1s ease-out 3.5s both;
        }
        .hero-description {
            font-size: 1.3rem;
            color: var(--gray);
            max-width: 700px;
            margin: 0 auto 40px;
            animation: fadeInUp 1s ease-out 3.7s both;
        }
        /* Navigation Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            animation: fadeInUp 1s ease-out 3.9s both;
        }
        .tab {
            padding: 12px 25px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 30px;
            color: var(--light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .tab:hover {
            background: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
        }
        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        /* Sections */
        .section {
            padding: 60px 0;
            animation: fadeIn 1s ease-out;
            display: none;
            opacity: 0;
            animation: fadeIn 1s ease-out 3.5s forwards;
        }
        .section.active {
            display: block;
        }
        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            color: var(--gold);
            position: relative;
        }
        .section-title::after {
            content: '';
            display: block;
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            margin: 15px auto;
        }
        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        .content-area {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        /* Chapters Grid */
        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        .chapter-card {
            background: rgba(30, 27, 75, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .chapter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
            border-color: var(--primary);
        }
        .chapter-card .chapter-number {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--primary);
            font-family: 'Cinzel', serif;
        }
        .chapter-card .chapter-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gold);
        }
        .chapter-card .chapter-description {
            color: var(--gray);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        /* Characters Section */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }
        .character-card {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            text-align: center;
        }
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
            border-color: var(--primary);
        }
        .character-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            object-fit: cover;
            border: 2px solid var(--gold);
        }
        .character-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            border: 2px solid var(--gold);
        }
        .character-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gold);
        }
        .character-description {
            color: var(--gray);
            font-size: 0.9rem;
        }
        /* Wiki Section */
        .wiki-content {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        .wiki-item {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        .wiki-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .wiki-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .wiki-text {
            color: var(--gray);
            line-height: 1.7;
        }
        /* Books List */
        .books-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .book-card {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            transition: all 0.3s ease;
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }
        .book-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            font-family: 'Cinzel', serif;
        }
        .book-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gold);
        }
        .book-description {
            color: var(--gray);
            font-size: 0.9rem;
        }
        /* Release Schedule */
        .schedule-table {
            width: 100%;
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        .schedule-table th,
        .schedule-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        .schedule-table th {
            background: rgba(139, 92, 246, 0.3);
            color: var(--light);
            font-weight: 600;
        }
        .schedule-table tr:last-child td {
            border-bottom: none;
        }
        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            transition: right 0.4s ease;
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid var(--primary);
        }
        .admin-panel.open {
            right: 0;
        }
        .admin-header {
            background: rgba(139, 92, 246, 0.2);
            color: var(--light);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--primary);
        }
        .admin-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        .close-admin {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .close-admin:hover {
            background: rgba(236, 72, 153, 0.2);
            transform: rotate(90deg);
        }
        .admin-content {
            padding: 20px;
        }
        .admin-section {
            margin-bottom: 30px;
            background: rgba(30, 27, 75, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        .admin-section h3 {
            margin-bottom: 20px;
            color: var(--gold);
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light);
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(15, 14, 36, 0.5);
            color: var(--light);
            font-family: 'Inter', sans-serif;
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 8px;
        }
        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
            display: none; /* Скрыто для обычных пользователей */
        }
        .admin-toggle.show {
            display: block;
        }
        .admin-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
        }
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }
        .overlay.active {
            display: block;
        }
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        .delete-btn {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            padding: 8px 15px;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        .delete-btn:hover {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Loading indicators */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        .error-message {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none;
        }
        .modal-content {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--primary);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .cancel-btn {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }
        .cancel-btn:hover {
            background: linear-gradient(45deg, #4b5563, #374151);
        }
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            margin-top: 50px;
            opacity: 0;
            animation: fadeIn 1s ease-out 4s forwards;
        }
        /* Color Settings */
        .color-setting {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .color-setting label {
            min-width: 120px;
        }
        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Maintenance Mode */
        .maintenance-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: var(--cyber-blue);
            font-family: 'Courier New', monospace;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .maintenance-mode.active {
            display: flex;
        }
        .terminal-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-bottom: 1px solid var(--cyber-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .terminal-title {
            font-weight: bold;
            text-shadow: 0 0 5px var(--cyber-blue);
            font-size: 1.2rem;
        }
        .terminal-close {
            background: none;
            border: 1px solid var(--cyber-blue);
            color: var(--cyber-blue);
            padding: 5px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
        }
        .terminal-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            background: #000;
            color: var(--cyber-blue);
        }
        .terminal-line {
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }
        .terminal-prompt {
            color: var(--cyber-blue);
            margin-right: 10px;
        }
        .terminal-command {
            color: var(--cyber-blue);
        }
        .terminal-output {
            color: var(--cyber-green);
        }
        .terminal-error {
            color: var(--cyber-red);
        }
        .terminal-warning {
            color: var(--cyber-yellow);
        }
        .maintenance-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }
        .maintenance-title {
            font-size: 3rem;
            color: var(--cyber-red);
            text-shadow: 0 0 20px var(--cyber-red);
            margin-bottom: 20px;
            animation: blink 1s infinite;
        }
        .maintenance-subtitle {
            font-size: 1.5rem;
            color: var(--cyber-blue);
            margin-bottom: 30px;
        }
        .maintenance-footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .matrix-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
            z-index: 1;
        }
        .matrix-char {
            position: absolute;
            color: var(--cyber-blue);
            font-size: 14px;
            opacity: 0;
        }
        .neon-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
            z-index: 2;
        }
        .neon-grid::before, .neon-grid::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 10px,
                rgba(0, 255, 255, 0.2) 10px,
                rgba(0, 255, 255, 0.2) 11px
            );
            transform-origin: center;
        }
        .neon-grid::before {
            transform: rotate(0deg);
        }
        .neon-grid::after {
            transform: rotate(90deg);
        }
        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            .hero-description {
                font-size: 1.1rem;
            }
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            .tab {
                width: 100%;
                text-align: center;
            }
            .admin-panel {
                width: 100%;
                right: -100%;
            }
            .chapters-menu {
                width: 100%;
                left: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Animation -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="stars" id="stars"></div>
        <div class="welcome-screen">
            <div class="welcome-text">Добро пожаловать на сайт!</div>
        </div>
    </div>

    <!-- Maintenance Mode -->
    <div class="maintenance-mode" id="maintenanceMode">
        <div class="terminal-header">
            <div class="terminal-title">CYBER_TERMINAL v2.1.5</div>
            <button class="terminal-close" onclick="exitMaintenanceMode()" id="exitMaintenanceBtn" style="display: none;">EXIT</button>
        </div>
        <div class="matrix-effect" id="matrixEffect"></div>
        <div class="neon-grid"></div>
        <div class="terminal-content" id="terminalContent">
            <!-- Terminal lines will be added here dynamically -->
        </div>
        <div class="maintenance-message">
            <div class="maintenance-title">САЙТ ПРИОСТАНОВЛЕН</div>
            <div class="maintenance-subtitle">Ведутся Технические работы</div>
        </div>
        <div class="maintenance-footer">
            SYSTEM STATUS: MAINTENANCE MODE ACTIVE | ACCESS RESTRICTED
        </div>
    </div>

    <!-- Chapters Menu -->
    <div class="chapters-menu" id="chaptersMenu">
        <div class="menu-header">
            <h2>Все главы</h2>
            <button class="close-menu" onclick="toggleChaptersMenu()">×</button>
        </div>
        <div class="menu-content">
            <div class="menu-chapters-list" id="menuChaptersList">
                <!-- Chapters will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Admin Toggle Button (только для админа) -->
    <button class="admin-toggle" id="adminToggle" onclick="toggleAdminPanel()">⚙️</button>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h2>Панель управления</h2>
            <button class="close-admin" onclick="toggleAdminPanel()">×</button>
        </div>
        <div class="admin-content">
            <div class="loading" id="adminLoading">
                <div class="spinner"></div>
                <p>Загрузка...</p>
            </div>
            <div class="error-message" id="adminError"></div>
            
            <!-- Maintenance Mode Toggle -->
            <div class="admin-section">
                <h3>Режим технических работ</h3>
                <button class="btn" onclick="toggleMaintenanceMode()" id="maintenanceToggleBtn">Включить тех. работы</button>
                <p style="margin-top: 10px; color: var(--gray); font-size: 0.9rem;">
                    При включении режима технических работ сайт будет недоступен для посетителей.
                </p>
            </div>

            <!-- Color Settings -->
            <div class="admin-section">
                <h3>Настройки цветов</h3>
                <div class="color-setting">
                    <label>Основной цвет:</label>
                    <input type="color" class="color-picker" id="primaryColor" value="#8B5CF6" onchange="updateColor('--primary', this.value)">
                </div>
                <div class="color-setting">
                    <label>Темный основной:</label>
                    <input type="color" class="color-picker" id="primaryDarkColor" value="#7C3AED" onchange="updateColor('--primary-dark', this.value)">
                </div>
                <div class="color-setting">
                    <label>Вторичный цвет:</label>
                    <input type="color" class="color-picker" id="secondaryColor" value="#EC4899" onchange="updateColor('--secondary', this.value)">
                </div>
                <div class="color-setting">
                    <label>Золотой цвет:</label>
                    <input type="color" class="color-picker" id="goldColor" value="#f59e0b" onchange="updateColor('--gold', this.value)">
                </div>
                <div class="color-setting">
                    <label>Темный фон:</label>
                    <input type="color" class="color-picker" id="darkColor" value="#1e1b4b" onchange="updateColor('--dark', this.value)">
                </div>
                <div class="color-setting">
                    <label>Очень темный:</label>
                    <input type="color" class="color-picker" id="darkerColor" value="#0f0e24" onchange="updateColor('--darker', this.value)">
                </div>
                <button class="btn" onclick="resetColors()">Сбросить цвета</button>
            </div>

            <div class="admin-section">
                <h3>Добавить Главу</h3>
                <div class="form-group">
                    <label>Номер главы (например: 7 или 7.1):</label>
                    <input type="text" id="chapterNumber" placeholder="Введите номер">
                </div>
                <div class="form-group">
                    <label>Название главы:</label>
                    <input type="text" id="chapterTitle" placeholder="Введите название">
                </div>
                <div class="form-group">
                    <label>Описание главы:</label>
                    <textarea id="chapterDescription" placeholder="Введите описание"></textarea>
                </div>
                <div class="form-group">
                    <label>Текст главы:</label>
                    <textarea id="chapterContent" placeholder="Введите текст главы"></textarea>
                </div>
                <button class="btn" onclick="addChapter()">Добавить Главу</button>
            </div>

            <div class="admin-section">
                <h3>Добавить Персонажа</h3>
                <div class="form-group">
                    <label>Имя персонажа:</label>
                    <input type="text" id="characterName" placeholder="Введите имя">
                </div>
                <div class="form-group">
                    <label>Описание персонажа:</label>
                    <textarea id="characterDescription" placeholder="Введите описание"></textarea>
                </div>
                <div class="form-group">
                    <label>Изображение персонажа:</label>
                    <input type="file" id="characterImage" accept="image/*">
                    <img id="characterImagePreview" class="image-preview" style="display: none;">
                </div>
                <button class="btn" onclick="addCharacter()">Добавить Персонажа</button>
            </div>

            <div class="admin-section">
                <h3>Добавить Факт в Википедию</h3>
                <div class="form-group">
                    <label>Заголовок:</label>
                    <input type="text" id="wikiTitle" placeholder="Введите заголовок">
                </div>
                <div class="form-group">
                    <label>Содержание:</label>
                    <textarea id="wikiContent" placeholder="Введите содержание"></textarea>
                </div>
                <button class="btn" onclick="addWikiItem()">Добавить Факт</button>
            </div>

            <div class="admin-section">
                <h3>Добавить Книгу в Серии</h3>
                <div class="form-group">
                    <label>Номер в серии:</label>
                    <input type="number" id="bookNumber" placeholder="Введите номер">
                </div>
                <div class="form-group">
                    <label>Название книги:</label>
                    <input type="text" id="bookTitle" placeholder="Введите название">
                </div>
                <div class="form-group">
                    <label>Описание книги:</label>
                    <textarea id="bookDescription" placeholder="Введите описание"></textarea>
                </div>
                <button class="btn" onclick="addBook()">Добавить Книгу</button>
            </div>

            <div class="admin-section">
                <h3>Добавить Дату Выхода</h3>
                <div class="form-group">
                    <label>Дата:</label>
                    <input type="date" id="releaseDate">
                </div>
                <div class="form-group">
                    <label>Описание:</label>
                    <input type="text" id="releaseDescription" placeholder="Введите описание">
                </div>
                <button class="btn" onclick="addReleaseDate()">Добавить Дату</button>
            </div>
            
            <button class="btn" onclick="logout()" style="background: linear-gradient(45deg, #ef4444, #dc2626); width: 100%;">Выйти</button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3 style="color: var(--gold); margin-bottom: 15px;">Подтверждение удаления</h3>
            <p id="deleteMessage">Вы уверены, что хотите удалить этот элемент?</p>
            <div class="modal-buttons">
                <button class="btn cancel-btn" onclick="closeDeleteModal()">Отмена</button>
                <button class="btn delete-btn" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <button class="menu-btn" onclick="toggleChaptersMenu()">☰</button>
                <a href="#" class="logo">Сердце Эфира: Селлестиал</a>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1>Сердце Эфира: Селлестиал</h1>
            <p class="hero-description" id="bookDescription">Фентезийная история о приключениях в мире магии и тайн</p>
        </div>
    </section>

    <!-- Navigation Tabs -->
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="showSection('chapters')">Главы</div>
            <div class="tab" onclick="showSection('characters')">Персонажи</div>
            <div class="tab" onclick="showSection('wiki')">Википедия</div>
            <div class="tab" onclick="showSection('books')">Серия книг</div>
            <div class="tab" onclick="showSection('schedule')">Расписание</div>
        </div>
    </div>

    <!-- Main Content Layout -->
    <div class="container">
        <div class="main-layout">
            <!-- Content Area -->
            <div class="content-area">
                <!-- Chapters Section -->
                <section class="section active" id="chaptersSection">
                    <h2 class="section-title">Главы книги</h2>
                    <div class="loading" id="chaptersLoading">
                        <div class="spinner"></div>
                        <p>Загрузка глав...</p>
                    </div>
                    <div class="chapters-grid" id="chaptersGrid">
                        <!-- Chapters will be added here dynamically -->
                    </div>
                </section>

                <!-- Characters Section -->
                <section class="section" id="charactersSection">
                    <h2 class="section-title">Персонажи</h2>
                    <div class="loading" id="charactersLoading">
                        <div class="spinner"></div>
                        <p>Загрузка персонажей...</p>
                    </div>
                    <div class="characters-grid" id="charactersGrid">
                        <!-- Characters will be added here dynamically -->
                    </div>
                </section>

                <!-- Wiki Section -->
                <section class="section" id="wikiSection">
                    <h2 class="section-title">Википедия</h2>
                    <div class="loading" id="wikiLoading">
                        <div class="spinner"></div>
                        <p>Загрузка википедии...</p>
                    </div>
                    <div class="wiki-content" id="wikiContent">
                        <!-- Wiki items will be added here dynamically -->
                    </div>
                </section>

                <!-- Books Series Section -->
                <section class="section" id="booksSection">
                    <h2 class="section-title">Серия книг</h2>
                    <div class="loading" id="booksLoading">
                        <div class="spinner"></div>
                        <p>Загрузка книг...</p>
                    </div>
                    <div class="books-list" id="booksList">
                        <!-- Books will be added here dynamically -->
                    </div>
                </section>

                <!-- Release Schedule Section -->
                <section class="section" id="scheduleSection">
                    <h2 class="section-title">Расписание выхода глав</h2>
                    <div class="loading" id="scheduleLoading">
                        <div class="spinner"></div>
                        <p>Загрузка расписания...</p>
                    </div>
                    <div class="schedule-table-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Описание</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule items will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="container">
        <div class="footer">
            <p>© 2024 Сердце Эфира: Селлестиал</p>
            <p>@WhiteX author: WhiteMeovv</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLuEVA6AYJereNnGnxDC8lqjCDmvGfqwc",
            authDomain: "heart-of-efir.firebaseapp.com",
            projectId: "heart-of-efir",
            storageBucket: "heart-of-efir.firebasestorage.app",
            messagingSenderId: "296902937897",
            appId: "1:296902937897:web:11de57e0de55eb84a63b38"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Check if user is admin
        let isAdmin = false;
        let deleteCallback = null;
        let isMaintenanceMode = false;

        // Create stars for welcome screen
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
                star.style.animationDelay = `${Math.random() * 2}s`;
                starsContainer.appendChild(star);
            }
        }

        // Toggle Chapters Menu
        function toggleChaptersMenu() {
            const menu = document.getElementById('chaptersMenu');
            const overlay = document.getElementById('overlay');
            
            menu.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // Toggle Admin Panel
        function toggleAdminPanel() {
            if (!isAdmin) return; // Только админ может открыть панель
            
            const panel = document.getElementById('adminPanel');
            const overlay = document.getElementById('overlay');
            
            panel.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // Close all panels
        function closeAllPanels() {
            document.getElementById('chaptersMenu').classList.remove('open');
            document.getElementById('adminPanel').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        // Update color
        function updateColor(variable, value) {
            document.documentElement.style.setProperty(variable, value);
        }

        // Reset colors
        function resetColors() {
            updateColor('--primary', '#8B5CF6');
            updateColor('--primary-dark', '#7C3AED');
            updateColor('--secondary', '#EC4899');
            updateColor('--gold', '#f59e0b');
            updateColor('--dark', '#1e1b4b');
            updateColor('--darker', '#0f0e24');
            
            document.getElementById('primaryColor').value = '#8B5CF6';
            document.getElementById('primaryDarkColor').value = '#7C3AED';
            document.getElementById('secondaryColor').value = '#EC4899';
            document.getElementById('goldColor').value = '#f59e0b';
            document.getElementById('darkColor').value = '#1e1b4b';
            document.getElementById('darkerColor').value = '#0f0e24';
        }

        // Authentication Functions
        function checkAdminStatus() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    isAdmin = true;
                    document.getElementById('adminToggle').classList.add('show');
                    checkMaintenanceMode(); // Проверяем режим тех. работ при входе админа
                } else {
                    isAdmin = false;
                    document.getElementById('adminToggle').classList.remove('show');
                }
            });
        }

        function login() {
            const email = prompt('Введите email администратора:');
            const password = prompt('Введите пароль:');
            
            if (email && password) {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        alert('Вы вошли как администратор');
                    })
                    .catch(error => {
                        alert('Ошибка входа: ' + error.message);
                    });
            }
        }

        function logout() {
            auth.signOut();
            toggleAdminPanel();
            alert('Вы вышли из системы');
        }

        // Maintenance Mode Functions
        async function checkMaintenanceMode() {
            try {
                const doc = await db.collection('settings').doc('maintenance').get();
                if (doc.exists) {
                    const data = doc.data();
                    isMaintenanceMode = data.enabled || false;
                    updateMaintenanceToggleButton();
                    
                    // Если админ вошел, не показываем режим тех. работ
                    if (!isAdmin) {
                        if (isMaintenanceMode) {
                            showMaintenanceMode();
                        }
                    }
                }
            } catch (error) {
                console.log('Ошибка проверки режима тех. работ:', error);
            }
        }

        function updateMaintenanceToggleButton() {
            const button = document.getElementById('maintenanceToggleBtn');
            if (button) {
                button.textContent = isMaintenanceMode ? 'Выключить тех. работы' : 'Включить тех. работы';
                button.style.background = isMaintenanceMode ? 
                    'linear-gradient(45deg, #ef4444, #dc2626)' : 
                    'linear-gradient(45deg, var(--primary), var(--secondary))';
            }
        }

        async function toggleMaintenanceMode() {
            if (!isAdmin) return;
            
            try {
                isMaintenanceMode = !isMaintenanceMode;
                
                // Сохраняем состояние в Firestore
                await db.collection('settings').doc('maintenance').set({
                    enabled: isMaintenanceMode,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: auth.currentUser ? auth.currentUser.uid : null
                }, { merge: true });
                
                updateMaintenanceToggleButton();
                
                if (isMaintenanceMode) {
                    alert('Режим технических работ включен!');
                    showMaintenanceMode();
                } else {
                    alert('Режим технических работ выключен!');
                    hideMaintenanceMode();
                }
            } catch (error) {
                console.error('Ошибка переключения режима тех. работ:', error);
                alert('Ошибка: ' + error.message);
                // Возвращаем предыдущее состояние
                isMaintenanceMode = !isMaintenanceMode;
                updateMaintenanceToggleButton();
            }
        }

        function showMaintenanceMode() {
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.classList.add('active');
                startTerminalSimulation();
                createMatrixEffect();
                createNeonGrid();
            }
        }

        function hideMaintenanceMode() {
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.classList.remove('active');
            }
        }

        function exitMaintenanceMode() {
            if (!isAdmin) return;
            
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.classList.remove('active');
            }
            
            // Показываем кнопку выхода для админа
            const exitBtn = document.getElementById('exitMaintenanceBtn');
            if (exitBtn) {
                exitBtn.style.display = 'block';
            }
        }

        function startTerminalSimulation() {
            const terminalContent = document.getElementById('terminalContent');
            if (!terminalContent) return;
            
            terminalContent.innerHTML = '';
            
            // Начальные строки терминала
            const initialLines = [
                '> Initializing CYBER_TERMINAL v2.1.5...',
                '> System boot sequence initiated',
                '> Loading kernel modules...',
                '> Establishing secure connection...',
                '> Authentication successful',
                '> Welcome, SYSTEM_ADMIN',
                '',
                '> SYSTEM STATUS: MAINTENANCE MODE',
                '> ACCESS TO PUBLIC CONTENT RESTRICTED',
                '> All services temporarily unavailable',
                '',
                '> INITIATING SYSTEM DIAGNOSTICS...',
                ''
            ];
            
            initialLines.forEach(line => {
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.textContent = line;
                terminalContent.appendChild(lineElement);
            });
            
            // Симуляция активности терминала
            setInterval(() => {
                const activities = [
                    '[INFO] Running system checks...',
                    '[INFO] Scanning for corrupted files...',
                    '[INFO] Running system checks...',
                    '[DEBUG] Cache cleared successfully',
                    '[WARNING] Disk space low (15% remaining)',
                    '[INFO] System optimization complete',
                    '[WARNING] Memory usage at 87%',
                    '[INFO] Log files archived',
                    '[DEBUG] Module core.dll loaded',
                    '[INFO] Encryption protocols updated',
                    '[INFO] SSL certificates renewed',
                    '[INFO] Firewall status: ACTIVE',
                    '[INFO] Network connectivity stable',
                    '[INFO] Database backup in progress...',
                    '[INFO] Security protocols updated',
                    '[INFO] API endpoints secured',
                    '[INFO] SSL certificates renewed',
                    '[INFO] Core modules initialized',
                    '[INFO] System diagnostics complete',
                    '[INFO] System ready for maintenance'
                ];
                
                const randomActivity = activities[Math.floor(Math.random() * activities.length)];
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.textContent = '> ' + randomActivity;
                terminalContent.appendChild(lineElement);
                terminalContent.scrollTop = terminalContent.scrollHeight;
            }, 2000);
        }

        function createMatrixEffect() {
            const matrixEffect = document.getElementById('matrixEffect');
            if (!matrixEffect) return;
            
            matrixEffect.innerHTML = '';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&*';
            const fontSize = 14;
            const columns = Math.floor(window.innerWidth / fontSize);
            
            for (let i = 0; i < 100; i++) {
                const char = document.createElement('div');
                char.className = 'matrix-char';
                char.textContent = chars[Math.floor(Math.random() * chars.length)];
                char.style.left = `${Math.random() * 100}%`;
                char.style.top = `${Math.random() * 100}%`;
                char.style.fontSize = `${Math.random() * 10 + 10}px`;
                char.style.opacity = Math.random() * 0.5;
                matrixEffect.appendChild(char);
                
                // Анимация падения
                animateMatrixChar(char);
            }
        }

        function createNeonGrid() {
            const neonGrid = document.querySelector('.neon-grid');
            if (!neonGrid) return;
            
            // Создаем анимацию сетки
            const interval = setInterval(() => {
                const currentOpacity = parseFloat(getComputedStyle(neonGrid).opacity);
                const newOpacity = currentOpacity === 0.1 ? 0.2 : 0.1;
                neonGrid.style.opacity = newOpacity;
            }, 1000);
            
            // Очищаем интервал при уничтожении элемента
            neonGrid.addEventListener('remove', () => clearInterval(interval));
        }

        function animateMatrixChar(char) {
            let posY = -20;
            const speed = Math.random() * 2 + 1;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&*';
            
            function fall() {
                posY += speed;
                char.style.top = `${posY}%`;
                
                if (posY > 100) {
                    posY = -20;
                    char.textContent = chars[Math.floor(Math.random() * chars.length)];
                }
                
                requestAnimationFrame(fall);
            }
            
            fall();
        }

        // Navigation Functions
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active class to clicked tab (if event exists)
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Show loading indicator
        function showLoading(section) {
            const loadingElement = document.getElementById(`${section}Loading`);
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
        }

        // Hide loading indicator
        function hideLoading(section) {
            const loadingElement = document.getElementById(`${section}Loading`);
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        // Show error message
        function showError(section, message) {
            const errorElement = document.getElementById(`${section}Error`) || 
                               document.getElementById('adminError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        // Modal functions
        function openDeleteModal(message, callback) {
            deleteCallback = callback;
            const messageElement = document.getElementById('deleteMessage');
            if (messageElement) {
                messageElement.textContent = message;
            }
            const modalElement = document.getElementById('deleteModal');
            if (modalElement) {
                modalElement.style.display = 'flex';
            }
        }
        
        function closeDeleteModal() {
            const modalElement = document.getElementById('deleteModal');
            if (modalElement) {
                modalElement.style.display = 'none';
            }
            deleteCallback = null;
        }
        
        function confirmDelete() {
            if (deleteCallback) {
                deleteCallback();
            }
            closeDeleteModal();
        }

        // Image preview
        document.addEventListener('DOMContentLoaded', function() {
            const characterImage = document.getElementById('characterImage');
            if (characterImage) {
                characterImage.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('characterImagePreview');
                            if (preview) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // CRUD Functions for Chapters
        async function addChapter() {
            if (!isAdmin) return;
            
            const chapterInput = document.getElementById('chapterNumber');
            const titleInput = document.getElementById('chapterTitle');
            const descriptionInput = document.getElementById('chapterDescription');
            const contentInput = document.getElementById('chapterContent');
            if (!chapterInput || !titleInput || !descriptionInput || !contentInput) {
                showError('admin', 'Ошибка: не найдены поля формы');
                return;
            }
            const chapterInputValue = chapterInput.value;
            const title = titleInput.value;
            const description = descriptionInput.value;
            const content = contentInput.value;
            if (!chapterInputValue || !title || !content) {
                showError('admin', 'Пожалуйста, заполните все обязательные поля');
                return;
            }
            try {
                showLoading('admin');
                const chapterData = {
                    title: title,
                    description: description,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                if (chapterInputValue.includes('.')) {
                    chapterData.chapterCode = chapterInputValue;
                } else {
                    chapterData.number = parseInt(chapterInputValue);
                }
                await db.collection('chapters').add(chapterData);
                await loadChapters();
                clearForm(['chapterNumber', 'chapterTitle', 'chapterDescription', 'chapterContent']);
                hideLoading('admin');
            } catch (error) {
                hideLoading('admin');
                showError('admin', 'Ошибка при добавлении главы: ' + error.message);
            }
        }

        async function loadChapters() {
            try {
                showLoading('chapters');
                const snapshot = await db.collection('chapters').get();
                const chapters = [];
                snapshot.forEach(doc => {
                    chapters.push({ id: doc.id, ...doc.data() });
                });
                renderChapters(chapters);
                renderMenuChapters(chapters);
                hideLoading('chapters');
            } catch (error) {
                hideLoading('chapters');
                showError('chapters', 'Ошибка при загрузке глав: ' + error.message);
            }
        }

        function renderChapters(chapters) {
            const container = document.getElementById('chaptersGrid');
            if (!container) return;
            container.innerHTML = '';
            chapters.sort((a, b) => {
                const numA = a.chapterCode !== undefined ? 
                    (typeof a.chapterCode === 'string' ? parseFloat(a.chapterCode) : a.chapterCode) : 
                    a.number;
                const numB = b.chapterCode !== undefined ? 
                    (typeof b.chapterCode === 'string' ? parseFloat(b.chapterCode) : b.chapterCode) : 
                    b.number;
                if (numA === numB) {
                    return a.id.localeCompare(b.id);
                }
                return numA - numB;
            });
            chapters.forEach(chapter => {
                const chapterNumber = chapter.chapterCode !== undefined ? chapter.chapterCode : chapter.number;
                const chapterCard = document.createElement('div');
                chapterCard.className = 'chapter-card';
                chapterCard.onclick = () => showChapter(chapter.id);
                chapterCard.innerHTML = `
                    <div class="chapter-number">Глава ${chapterNumber}</div>
                    <h3 class="chapter-title">${chapter.title || 'Без названия'}</h3>
                    <p class="chapter-description">${chapter.description || ''}</p>
                    ${isAdmin ? `<button class="btn delete-btn" onclick="event.stopPropagation(); deleteChapter('${chapter.id}', '${chapter.title || 'Без названия'}')">Удалить</button>` : ''}
                `;
                container.appendChild(chapterCard);
            });
        }

        function renderMenuChapters(chapters) {
            const container = document.getElementById('menuChaptersList');
            if (!container) return;
            container.innerHTML = '';
            chapters.sort((a, b) => {
                const numA = a.chapterCode !== undefined ? 
                    (typeof a.chapterCode === 'string' ? parseFloat(a.chapterCode) : a.chapterCode) : 
                    a.number;
                const numB = b.chapterCode !== undefined ? 
                    (typeof b.chapterCode === 'string' ? parseFloat(b.chapterCode) : b.chapterCode) : 
                    b.number;
                return numA - numB;
            });
            chapters.forEach(chapter => {
                const chapterNumber = chapter.chapterCode !== undefined ? chapter.chapterCode : chapter.number;
                const chapterItem = document.createElement('div');
                chapterItem.className = 'chapter-item';
                chapterItem.innerHTML = `
                    <div class="chapter-number">Глава ${chapterNumber}</div>
                    <div class="chapter-title">${chapter.title || 'Без названия'}</div>
                `;
                chapterItem.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        e.stopPropagation();
                        showChapter(chapter.id);
                        toggleChaptersMenu();
                    }
                };
                container.appendChild(chapterItem);
            });
        }

        function showChapter(id) {
            window.location.href = `chapter.html?id=${id}`;
        }

        async function deleteChapter(chapterId, chapterTitle) {
            if (!isAdmin) return;
            openDeleteModal(`Вы уверены, что хотите удалить главу "${chapterTitle}"?`, async () => {
                try {
                    showLoading('admin');
                    await db.collection('chapters').doc(chapterId).delete();
                    await loadChapters();
                    hideLoading('admin');
                    alert('Глава успешно удалена!');
                } catch (error) {
                    hideLoading('admin');
                    showError('admin', 'Ошибка при удалении главы: ' + error.message);
                }
            });
        }

        // CRUD Functions for Characters
        async function addCharacter() {
            if (!isAdmin) return;
            const nameInput = document.getElementById('characterName');
            const descriptionInput = document.getElementById('characterDescription');
            const imageInput = document.getElementById('characterImage');
            if (!nameInput || !descriptionInput) {
                showError('admin', 'Ошибка: не найдены поля формы');
                return;
            }
            const name = nameInput.value;
            const description = descriptionInput.value;
            const imageFile = imageInput ? imageInput.files[0] : null;
            if (!name || !description) {
                showError('admin', 'Пожалуйста, заполните все поля');
                return;
            }
            try {
                showLoading('admin');
                const characterData = {
                    name: name,
                    description: description,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                // Upload image if provided
                if (imageFile) {
                    try {
                        const storageRef = storage.ref();
                        const imageRef = storageRef.child(`characters/${Date.now()}_${imageFile.name}`);
                        await imageRef.put(imageFile);
                        const imageUrl = await imageRef.getDownloadURL();
                        characterData.imageUrl = imageUrl;
                    } catch (storageError) {
                        console.warn('Ошибка загрузки изображения:', storageError);
                        // Продолжаем без изображения
                    }
                }
                await db.collection('characters').add(characterData);
                await loadCharacters();
                clearForm(['characterName', 'characterDescription']);
                if (imageInput) imageInput.value = '';
                const preview = document.getElementById('characterImagePreview');
                if (preview) preview.style.display = 'none';
                hideLoading('admin');
            } catch (error) {
                hideLoading('admin');
                showError('admin', 'Ошибка при добавлении персонажа: ' + error.message);
            }
        }

        async function loadCharacters() {
            try {
                showLoading('characters');
                const snapshot = await db.collection('characters').get();
                const characters = [];
                snapshot.forEach(doc => {
                    characters.push({ id: doc.id, ...doc.data() });
                });
                renderCharacters(characters);
                hideLoading('characters');
            } catch (error) {
                hideLoading('characters');
                showError('characters', 'Ошибка при загрузке персонажей: ' + error.message);
            }
        }

        function renderCharacters(characters) {
            const container = document.getElementById('charactersGrid');
            if (!container) return;
            container.innerHTML = '';
            characters.forEach(character => {
                const characterElement = document.createElement('div');
                characterElement.className = 'character-card';
                let imageHtml = '';
                if (character.imageUrl) {
                    imageHtml = `<img src="${character.imageUrl}" alt="${character.name || 'Персонаж'}" class="character-image" onerror="this.style.display='none';this.nextElementSibling.style.display='block';">`;
                    imageHtml += `<div class="character-avatar" style="display:none;">${(character.name || '?').charAt(0)}</div>`;
                } else {
                    imageHtml = `<div class="character-avatar">${(character.name || '?').charAt(0)}</div>`;
                }
                characterElement.innerHTML = `
                    ${imageHtml}
                    <h3 class="character-name">${character.name || 'Без имени'}</h3>
                    <p class="character-description">${character.description || ''}</p>
                    ${isAdmin ? `<button class="btn delete-btn" onclick="deleteCharacter('${character.id}', '${character.name || 'Без имени'}')">Удалить</button>` : ''}
                `;
                container.appendChild(characterElement);
            });
        }

        async function deleteCharacter(characterId, characterName) {
            if (!isAdmin) return;
            openDeleteModal(`Вы уверены, что хотите удалить персонажа "${characterName}"?`, async () => {
                try {
                    showLoading('admin');
                    await db.collection('characters').doc(characterId).delete();
                    await loadCharacters();
                    hideLoading('admin');
                    alert('Персонаж успешно удален!');
                } catch (error) {
                    hideLoading('admin');
                    showError('admin', 'Ошибка при удалении персонажа: ' + error.message);
                }
            });
        }

        // CRUD Functions for Wiki
        async function addWikiItem() {
            if (!isAdmin) return;
            const titleInput = document.getElementById('wikiTitle');
            const contentInput = document.getElementById('wikiContent');
            if (!titleInput || !contentInput) {
                showError('admin', 'Ошибка: не найдены поля формы');
                return;
            }
            const title = titleInput.value;
            const content = contentInput.value;
            if (!title || !content) {
                showError('admin', 'Пожалуйста, заполните все поля');
                return;
            }
            try {
                showLoading('admin');
                await db.collection('wiki').add({
                    title: title,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadWiki();
                clearForm(['wikiTitle', 'wikiContent']);
                hideLoading('admin');
            } catch (error) {
                hideLoading('admin');
                showError('admin', 'Ошибка при добавлении факта: ' + error.message);
            }
        }

        async function loadWiki() {
            try {
                showLoading('wiki');
                const snapshot = await db.collection('wiki').get();
                const wikiItems = [];
                snapshot.forEach(doc => {
                    wikiItems.push({ id: doc.id, ...doc.data() });
                });
                renderWiki(wikiItems);
                hideLoading('wiki');
            } catch (error) {
                hideLoading('wiki');
                showError('wiki', 'Ошибка при загрузке википедии: ' + error.message);
            }
        }

        function renderWiki(wikiItems) {
            const container = document.getElementById('wikiContent');
            if (!container) return;
            container.innerHTML = '';
            wikiItems.forEach(item => {
                const wikiItem = document.createElement('div');
                wikiItem.className = 'wiki-item';
                wikiItem.innerHTML = `
                    <h3 class="wiki-title">${item.title || 'Без заголовка'}</h3>
                    <div class="wiki-text">${item.content || ''}</div>
                    ${isAdmin ? `<button class="btn delete-btn" onclick="deleteWikiItem('${item.id}', '${item.title || 'Без заголовка'}')">Удалить</button>` : ''}
                `;
                container.appendChild(wikiItem);
            });
        }

        async function deleteWikiItem(wikiId, wikiTitle) {
            if (!isAdmin) return;
            openDeleteModal(`Вы уверены, что хотите удалить запись "${wikiTitle}"?`, async () => {
                try {
                    showLoading('admin');
                    await db.collection('wiki').doc(wikiId).delete();
                    await loadWiki();
                    hideLoading('admin');
                    alert('Запись успешно удалена!');
                } catch (error) {
                    hideLoading('admin');
                    showError('admin', 'Ошибка при удалении записи: ' + error.message);
                }
            });
        }

        // CRUD Functions for Books
        async function addBook() {
            if (!isAdmin) return;
            const numberInput = document.getElementById('bookNumber');
            const titleInput = document.getElementById('bookTitle');
            const descriptionInput = document.getElementById('bookDescription');
            if (!numberInput || !titleInput || !descriptionInput) {
                showError('admin', 'Ошибка: не найдены поля формы');
                return;
            }
            const number = numberInput.value;
            const title = titleInput.value;
            const description = descriptionInput.value;
            if (!number || !title) {
                showError('admin', 'Пожалуйста, заполните обязательные поля');
                return;
            }
            try {
                showLoading('admin');
                await db.collection('books').add({
                    number: parseInt(number),
                    title: title,
                    description: description,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadBooks();
                clearForm(['bookNumber', 'bookTitle', 'bookDescription']);
                hideLoading('admin');
            } catch (error) {
                hideLoading('admin');
                showError('admin', 'Ошибка при добавлении книги: ' + error.message);
            }
        }

        async function loadBooks() {
            try {
                showLoading('books');
                const snapshot = await db.collection('books').get();
                const books = [];
                snapshot.forEach(doc => {
                    books.push({ id: doc.id, ...doc.data() });
                });
                renderBooks(books);
                hideLoading('books');
            } catch (error) {
                hideLoading('books');
                showError('books', 'Ошибка при загрузке книг: ' + error.message);
            }
        }

        function renderBooks(books) {
            const container = document.getElementById('booksList');
            if (!container) return;
            container.innerHTML = '';
            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.innerHTML = `
                    <div class="book-number">${book.number || '?'}</div>
                    <h3 class="book-title">${book.title || 'Без названия'}</h3>
                    <p class="book-description">${book.description || ''}</p>
                    ${isAdmin ? `<button class="btn delete-btn" onclick="deleteBook('${book.id}', '${book.title || 'Без названия'}')">Удалить</button>` : ''}
                `;
                container.appendChild(bookCard);
            });
        }

        async function deleteBook(bookId, bookTitle) {
            if (!isAdmin) return;
            openDeleteModal(`Вы уверены, что хотите удалить книгу "${bookTitle}"?`, async () => {
                try {
                    showLoading('admin');
                    await db.collection('books').doc(bookId).delete();
                    await loadBooks();
                    hideLoading('admin');
                    alert('Книга успешно удалена!');
                } catch (error) {
                    hideLoading('admin');
                    showError('admin', 'Ошибка при удалении книги: ' + error.message);
                }
            });
        }

        // CRUD Functions for Schedule
        async function addReleaseDate() {
            if (!isAdmin) return;
            const dateInput = document.getElementById('releaseDate');
            const descriptionInput = document.getElementById('releaseDescription');
            if (!dateInput || !descriptionInput) {
                showError('admin', 'Ошибка: не найдены поля формы');
                return;
            }
            const date = dateInput.value;
            const description = descriptionInput.value;
            if (!date || !description) {
                showError('admin', 'Пожалуйста, заполните все поля');
                return;
            }
            try {
                showLoading('admin');
                await db.collection('schedule').add({
                    date: new Date(date),
                    description: description,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadSchedule();
                clearForm(['releaseDate', 'releaseDescription']);
                hideLoading('admin');
            } catch (error) {
                hideLoading('admin');
                showError('admin', 'Ошибка при добавлении даты: ' + error.message);
            }
        }

        async function loadSchedule() {
            try {
                showLoading('schedule');
                const snapshot = await db.collection('schedule').orderBy('date').get();
                const schedule = [];
                snapshot.forEach(doc => {
                    schedule.push({ id: doc.id, ...doc.data() });
                });
                renderSchedule(schedule);
                hideLoading('schedule');
            } catch (error) {
                hideLoading('schedule');
                showError('schedule', 'Ошибка при загрузке расписания: ' + error.message);
            }
        }

        function renderSchedule(schedule) {
            const container = document.getElementById('scheduleTable');
            if (!container) return;
            container.innerHTML = '';
            schedule.forEach(date => {
                const row = document.createElement('tr');
                const dateStr = date.date instanceof Date ? 
                    date.date.toLocaleDateString('ru-RU') : 
                    new Date(date.date.seconds * 1000).toLocaleDateString('ru-RU');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${date.description || ''}</td>
                    ${isAdmin ? `<td><button class="btn delete-btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="deleteScheduleItem('${date.id}', '${date.description || 'Без описания'}')">Удалить</button></td>` : '<td></td>'}
                `;
                container.appendChild(row);
            });
        }

        async function deleteScheduleItem(scheduleId, scheduleDescription) {
            if (!isAdmin) return;
            openDeleteModal(`Вы уверены, что хотите удалить запись "${scheduleDescription}"?`, async () => {
                try {
                    showLoading('admin');
                    await db.collection('schedule').doc(scheduleId).delete();
                    await loadSchedule();
                    hideLoading('admin');
                    alert('Запись успешно удалена!');
                } catch (error) {
                    hideLoading('admin');
                    showError('admin', 'Ошибка при удалении записи: ' + error.message);
                }
            });
        }

        // Clear form fields
        function clearForm(fields) {
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadChapters(),
                loadCharacters(),
                loadWiki(),
                loadBooks(),
                loadSchedule()
            ]);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            createStars();
            
            // Hide loading overlay after 3 seconds
            setTimeout(() => {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }, 3000);
            
            // Check admin status
            checkAdminStatus();
            
            // Check maintenance mode
            checkMaintenanceMode();
            
            // Load all data
            loadAllData();
            
            // Show initial section
            showSection('chapters');
        });
    </script>
</body>
</html>
