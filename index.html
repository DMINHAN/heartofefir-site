<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сердце Эфира: Селлестиал</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;500;600;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #EC4899;
            --accent: #06B6D4;
            --dark: #1e1b4b;
            --darker: #0f0e24;
            --light: #f0f9ff;
            --gray: #94a3b8;
            --border: #334155;
            --gold: #f59e0b;
            --cyber-blue: #00bfff;
            --cyber-purple: #8a2be2;
            --cyber-pink: #ff1493;
            --cyber-red: #ff0000;
            --cyber-yellow: #ffff00;
            --cyber-green: #00ff00;
            --cyber-cyan: #00ffff;
            --cyber-magenta: #ff00ff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 20%);
            z-index: -1;
        }
        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }
        .welcome-screen {
            text-align: center;
            position: relative;
            z-index: 1001;
        }
        .welcome-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
            animation: pulse 2s infinite, fadeInOut 3s forwards;
        }
        /* Stars animation */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle var(--duration, 3s) infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        /* Header Styles */
        header {
            background: rgba(30, 27, 75, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }
        .logo {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--gold);
            text-decoration: none;
            text-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
            transition: all 0.3s ease;
        }
        .logo:hover {
            transform: scale(1.05);
            text-shadow: 0 0 25px rgba(245, 158, 11, 0.8);
        }
        /* Menu Button */
        .menu-btn {
            background: none;
            border: none;
            color: var(--light);
            font-size: 2rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .menu-btn:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        /* Chapters Menu */
        .chapters-menu {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            transition: left 0.4s ease;
            z-index: 1000;
            overflow-y: auto;
            border-right: 1px solid var(--primary);
        }
        .chapters-menu.open {
            left: 0;
        }
        .menu-header {
            background: rgba(139, 92, 246, 0.2);
            color: var(--light);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--primary);
        }
        .menu-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--gold);
        }
        .close-menu {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .close-menu:hover {
            background: rgba(236, 72, 153, 0.2);
            transform: rotate(90deg);
        }
        .menu-content {
            padding: 20px;
        }
        .menu-chapters-list {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(139, 92, 246, 0.3);
        }
        .menu-chapters-list::-webkit-scrollbar {
            width: 8px;
        }
        .menu-chapters-list::-webkit-scrollbar-track {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
        }
        .menu-chapters-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        .menu-chapters-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        /* Hero Section */
        .hero {
            padding: 100px 0 60px;
            text-align: center;
            position: relative;
            opacity: 0;
            animation: fadeIn 1s ease-out 3.5s forwards;
        }
        .hero h1 {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--gold);
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
            animation: fadeInUp 1s ease-out 3.5s both;
        }
        .hero-description {
            font-size: 1.3rem;
            color: var(--gray);
            max-width: 700px;
            margin: 0 auto 40px;
            animation: fadeInUp 1s ease-out 3.7s both;
        }
        /* Navigation Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            animation: fadeInUp 1s ease-out 3.9s both;
        }
        .tab {
            padding: 12px 25px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 30px;
            color: var(--light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .tab:hover {
            background: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
        }
        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        /* Sections */
        .section {
            padding: 60px 0;
            animation: fadeIn 1s ease-out;
            display: none;
            opacity: 0;
            animation: fadeIn 1s ease-out 3.5s forwards;
        }
        .section.active {
            display: block;
        }
        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            color: var(--gold);
            position: relative;
        }
        .section-title::after {
            content: '';
            display: block;
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            margin: 15px auto;
        }
        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        .content-area {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        /* Chapters Grid */
        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        .chapter-card {
            background: rgba(30, 27, 75, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .chapter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
            border-color: var(--primary);
        }
        .chapter-card .chapter-number {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--primary);
            font-family: 'Cinzel', serif;
        }
        .chapter-card .chapter-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gold);
        }
        .chapter-card .chapter-description {
            color: var(--gray);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        /* Characters Section */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }
        .character-card {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            text-align: center;
        }
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
            border-color: var(--primary);
        }
        .character-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            object-fit: cover;
            border: 2px solid var(--gold);
        }
        .character-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            border: 2px solid var(--gold);
        }
        .character-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gold);
        }
        .character-description {
            color: var(--gray);
            font-size: 0.9rem;
        }
        /* Wiki Section */
        .wiki-content {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        .wiki-item {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        .wiki-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .wiki-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .wiki-text {
            color: var(--gray);
            line-height: 1.7;
        }
        /* Books List */
        .books-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .book-card {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            transition: all 0.3s ease;
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }
        .book-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            font-family: 'Cinzel', serif;
        }
        .book-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gold);
        }
        .book-description {
            color: var(--gray);
            font-size: 0.9rem;
        }
        /* Release Schedule */
        .schedule-table {
            width: 100%;
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        .schedule-table th,
        .schedule-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        .schedule-table th {
            background: rgba(139, 92, 246, 0.3);
            color: var(--light);
            font-weight: 600;
        }
        .schedule-table tr:last-child td {
            border-bottom: none;
        }
        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            max-width: 90vw;
            height: 80vh;
            max-height: 90vh;
            background: #000;
            color: var(--cyber-blue);
            font-family: 'Courier New', monospace;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--cyber-blue);
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.5);
        }
        .admin-panel.active {
            display: flex;
        }
        .admin-terminal-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-bottom: 1px solid var(--cyber-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-terminal-title {
            font-weight: bold;
            text-shadow: 0 0 5px var(--cyber-blue);
            font-size: 1.4rem;
            letter-spacing: 2px;
        }
        .admin-terminal-close {
            background: none;
            border: 1px solid var(--cyber-red);
            color: var(--cyber-red);
            padding: 8px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .admin-terminal-close:hover {
            background: var(--cyber-red);
            color: #000;
            box-shadow: 0 0 10px var(--cyber-red);
        }
        .admin-terminal-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            background: #000;
            color: var(--cyber-blue);
        }
        .admin-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--cyber-blue);
        }
        .admin-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .admin-section h3 {
            font-size: 1.3rem;
            color: var(--cyber-yellow);
            margin-bottom: 15px;
            text-shadow: 0 0 3px var(--cyber-yellow);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--cyber-green);
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--cyber-blue);
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--cyber-blue);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .color-setting {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .color-setting label {
            min-width: 120px;
            color: var(--cyber-green);
        }
        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-admin {
            display: inline-block;
            padding: 10px 20px;
            background: var(--cyber-blue);
            color: #000;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 1px solid var(--cyber-blue);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .btn-admin:hover {
            background: #000;
            color: var(--cyber-blue);
            box-shadow: 0 0 10px var(--cyber-blue);
        }
        .btn-admin-danger {
            background: var(--cyber-red);
            color: #000;
        }
        .btn-admin-danger:hover {
            background: #000;
            color: var(--cyber-red);
            box-shadow: 0 0 10px var(--cyber-red);
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: rgba(0, 191, 255, 0.1);
            padding: 15px;
            border: 1px solid var(--cyber-blue);
            border-radius: 5px;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--cyber-yellow);
            margin: 5px 0;
        }
        .stat-label {
            color: var(--cyber-green);
            font-size: 0.9rem;
        }
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1999;
            display: none;
        }
        .overlay.active {
            display: block;
        }
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        .delete-btn {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            padding: 8px 15px;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        .delete-btn:hover {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            60% { transform: translate(-5px, -5px); }
            80% { transform: translate(5px, 5px); }
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* Loading indicators */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        .error-message {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none;
        }
        .modal-content {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid var(--primary);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .cancel-btn {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }
        .cancel-btn:hover {
            background: linear-gradient(45deg, #4b5563, #374151);
        }
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            margin-top: 50px;
            opacity: 0;
            animation: fadeIn 1s ease-out 4s forwards;
        }
        /* Chat/Messenger */
        .chat-container {
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            margin-top: 30px;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: var(--gold);
            font-family: 'Cinzel', serif;
        }
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(15, 14, 36, 0.5);
            border-radius: 8px;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        .message-user {
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 5px;
        }
        .message-text {
            color: var(--light);
        }
        .message-time {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: right;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(15, 14, 36, 0.5);
            color: var(--light);
        }
        .chat-input button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(30, 27, 75, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            margin-bottom: 20px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold);
        }
        .user-info {
            flex: 1;
        }
        .user-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--gold);
        }
        .user-rank {
            color: var(--primary);
            font-size: 0.9rem;
        }
        .user-stats {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        /* Chapter Cards in Menu */
        .chapter-menu-card {
            background: rgba(30, 27, 75, 0.7);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .chapter-menu-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
            border-color: var(--primary);
        }
        .chapter-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .chapter-menu-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Cinzel', serif;
        }
        .chapter-menu-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 10px;
        }
        .chapter-menu-desc {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .chapter-menu-read-btn {
            display: inline-block;
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .chapter-menu-read-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            .hero-description {
                font-size: 1.1rem;
            }
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            .tab {
                width: 100%;
                text-align: center;
            }
            .admin-panel {
                width: 95vw;
                height: 90vh;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Animation -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="stars" id="stars"></div>
        <div class="welcome-screen">
            <div class="welcome-text">Добро пожаловать на сайт!</div>
        </div>
    </div>

    <!-- Maintenance Mode -->
    <div class="maintenance-mode" id="maintenanceMode">
        <div class="terminal-header">
            <div class="terminal-title">CYBER_TERMINAL v2.1.5</div>
            <button class="terminal-close" onclick="exitMaintenanceMode()" id="exitMaintenanceBtn" style="display: none;">EXIT</button>
        </div>
        <div class="matrix-effect" id="matrixEffect"></div>
        <div class="neon-grid"></div>
        <div class="terminal-content" id="terminalContent">
            <!-- Terminal lines will be added here dynamically -->
        </div>
        <div class="maintenance-message">
            <div class="maintenance-title">САЙТ ПРИОСТАНОВЛЕН</div>
            <div class="maintenance-subtitle">Ведутся Технические работы</div>
        </div>
        <div class="maintenance-footer">
            SYSTEM STATUS: MAINTENANCE MODE ACTIVE | ACCESS RESTRICTED
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-terminal-header">
            <div class="admin-terminal-title">WhiteX.ADMIN TOOL</div>
            <button class="admin-terminal-close" onclick="toggleAdminPanel()">CLOSE</button>
        </div>
        <div class="admin-terminal-content" id="adminTerminalContent">
            <!-- Admin content will be added here dynamically -->
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <button class="menu-btn" onclick="toggleChaptersMenu()">☰</button>
                <a href="#" class="logo">Сердце Эфира: Селлестиал</a>
                <button class="admin-toggle" id="adminToggle" onclick="toggleAdminPanel()">⚙️</button>
            </div>
        </div>
    </header>

    <!-- Chapters Menu -->
    <div class="chapters-menu" id="chaptersMenu">
        <div class="menu-header">
            <h2>Все главы</h2>
            <button class="close-menu" onclick="toggleChaptersMenu()">×</button>
        </div>
        <div class="menu-content">
            <div class="menu-chapters-list" id="menuChaptersList">
                <!-- Chapters will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3 style="color: var(--gold); margin-bottom: 15px;">Подтверждение удаления</h3>
            <p id="deleteMessage">Вы уверены, что хотите удалить этот элемент?</p>
            <div class="modal-buttons">
                <button class="btn cancel-btn" onclick="closeDeleteModal()">Отмена</button>
                <button class="btn delete-btn" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1>Сердце Эфира: Селлестиал</h1>
            <p class="hero-description" id="bookDescription">Фентезийная история о приключениях в мире магии и тайн</p>
        </div>
    </section>

    <!-- Navigation Tabs -->
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="showSection('chapters')">Главы</div>
            <div class="tab" onclick="showSection('characters')">Персонажи</div>
            <div class="tab" onclick="showSection('wiki')">Википедия</div>
            <div class="tab" onclick="showSection('books')">Серия книг</div>
            <div class="tab" onclick="showSection('schedule')">Расписание</div>
        </div>
    </div>

    <!-- Main Content Layout -->
    <div class="container">
        <div class="main-layout">
            <!-- Content Area -->
            <div class="content-area">
                <!-- Chapters Section -->
                <section class="section active" id="chaptersSection">
                    <h2 class="section-title">Главы книги</h2>
                    <div class="loading" id="chaptersLoading">
                        <div class="spinner"></div>
                        <p>Загрузка глав...</p>
                    </div>
                    <div class="chapters-grid" id="chaptersGrid">
                        <!-- Chapters will be added here dynamically -->
                    </div>
                </section>

                <!-- Characters Section -->
                <section class="section" id="charactersSection">
                    <h2 class="section-title">Персонажи</h2>
                    <div class="loading" id="charactersLoading">
                        <div class="spinner"></div>
                        <p>Загрузка персонажей...</p>
                    </div>
                    <div class="characters-grid" id="charactersGrid">
                        <!-- Characters will be added here dynamically -->
                    </div>
                </section>

                <!-- Wiki Section -->
                <section class="section" id="wikiSection">
                    <h2 class="section-title">Википедия</h2>
                    <div class="loading" id="wikiLoading">
                        <div class="spinner"></div>
                        <p>Загрузка википедии...</p>
                    </div>
                    <div class="wiki-content" id="wikiContent">
                        <!-- Wiki items will be added here dynamically -->
                    </div>
                </section>

                <!-- Books Series Section -->
                <section class="section" id="booksSection">
                    <h2 class="section-title">Серия книг</h2>
                    <div class="loading" id="booksLoading">
                        <div class="spinner"></div>
                        <p>Загрузка книг...</p>
                    </div>
                    <div class="books-list" id="booksList">
                        <!-- Books will be added here dynamically -->
                    </div>
                </section>

                <!-- Release Schedule Section -->
                <section class="section" id="scheduleSection">
                    <h2 class="section-title">Расписание выхода глав</h2>
                    <div class="loading" id="scheduleLoading">
                        <div class="spinner"></div>
                        <p>Загрузка расписания...</p>
                    </div>
                    <div class="schedule-table-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Описание</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule items will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Messenger Section -->
                <section class="section" id="messengerSection">
                    <h2 class="section-title">Чат сообщества</h2>
                    <div class="chat-container">
                        <div class="chat-header">
                            <h3>Общий чат</h3>
                            <span id="onlineUsers">Пользователей онлайн: 0</span>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <!-- Messages will be added here dynamically -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="Введите сообщение...">
                            <button onclick="sendMessage()">Отправить</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="container">
        <div class="footer">
            <p>© 2024 Сердце Эфира: Селлестиал</p>
            <p>@WhiteX author: WhiteMeovv</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLuEVA6AYJereNnGnxDC8lqjCDmvGfqwc",
            authDomain: "heart-of-efir.firebaseapp.com",
            projectId: "heart-of-efir",
            storageBucket: "heart-of-efir.firebasestorage.app",
            messagingSenderId: "296902937897",
            appId: "1:296902937897:web:11de57e0de55eb84a63b38"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Check if user is admin
        let isAdmin = false;
        let deleteCallback = null;
        let currentUser = null;

        // Create stars for welcome screen
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
                star.style.animationDelay = `${Math.random() * 2}s`;
                starsContainer.appendChild(star);
            }
        }

        // Toggle Chapters Menu
        function toggleChaptersMenu() {
            const menu = document.getElementById('chaptersMenu');
            const overlay = document.getElementById('overlay');
            
            menu.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        // Toggle Admin Panel with glitch effect
        async function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            const overlay = document.getElementById('overlay');
            
            if (panel.classList.contains('active')) {
                // Close panel
                panel.classList.remove('active');
                overlay.classList.remove('active');
                return;
            }
            
            // Check if user is admin
            if (!isAdmin) return;
            
            // Show loading glitch effect
            await showGlitchEffect();
            
            // Show admin panel
            panel.classList.add('active');
            overlay.classList.add('active');
            
            // Load admin content
            loadAdminContent();
        }

        // Show glitch effect before admin panel
        async function showGlitchEffect() {
            const terminalContent = document.getElementById('adminTerminalContent');
            if (!terminalContent) return;
            
            terminalContent.innerHTML = '';
            
            // Create glitch effect
            const glitchLines = [
                '> INITIALIZING ADMIN TERMINAL...',
                '> AUTHENTICATION REQUIRED',
                '> VERIFYING CREDENTIALS...',
                '',
                '> WhiteX.ADMIN TOOL',
                '',
                '> LOADING MODULES...'
            ];
            
            for (let line of glitchLines) {
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.textContent = line;
                terminalContent.appendChild(lineElement);
                
                // Add glitch effect
                if (line.includes('INITIALIZING') || line.includes('WhiteX.ADMIN TOOL')) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Glitch animation
                    for (let i = 0; i < 3; i++) {
                        lineElement.style.transform = 'translate(-3px, 3px)';
                        await new Promise(resolve => setTimeout(resolve, 100));
                        lineElement.style.transform = 'translate(3px, -3px)';
                        await new Promise(resolve => setTimeout(resolve, 100));
                        lineElement.style.transform = 'translate(-3px, -3px)';
                        await new Promise(resolve => setTimeout(resolve, 100));
                        lineElement.style.transform = 'translate(3px, 3px)';
                        await new Promise(resolve => setTimeout(resolve, 100));
                        lineElement.style.transform = 'translate(0, 0)';
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        // Load admin content
        function loadAdminContent() {
            const terminalContent = document.getElementById('adminTerminalContent');
            if (!terminalContent) return;
            
            terminalContent.innerHTML = `
                <div class="admin-section">
                    <h3>COLOR SETTINGS</h3>
                    <div class="color-setting">
                        <label>PRIMARY:</label>
                        <input type="color" class="color-picker" id="adminPrimaryColor" value="#8B5CF6" onchange="updateAdminColor('--primary', this.value)">
                    </div>
                    <div class="color-setting">
                        <label>SECONDARY:</label>
                        <input type="color" class="color-picker" id="adminSecondaryColor" value="#EC4899" onchange="updateAdminColor('--secondary', this.value)">
                    </div>
                    <div class="color-setting">
                        <label>GOLD:</label>
                        <input type="color" class="color-picker" id="adminGoldColor" value="#f59e0b" onchange="updateAdminColor('--gold', this.value)">
                    </div>
                    <button class="btn-admin" onclick="resetColors()">RESET COLORS</button>
                </div>

                <div class="admin-section">
                    <h3>ADD CHAPTER</h3>
                    <div class="form-group">
                        <label>CHAPTER NUMBER:</label>
                        <input type="text" id="adminChapterNumber" placeholder="7 or 7.1">
                    </div>
                    <div class="form-group">
                        <label>TITLE:</label>
                        <input type="text" id="adminChapterTitle" placeholder="Enter title">
                    </div>
                    <div class="form-group">
                        <label>DESCRIPTION:</label>
                        <textarea id="adminChapterDescription" placeholder="Enter description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>CONTENT:</label>
                        <textarea id="adminChapterContent" placeholder="Enter chapter content"></textarea>
                    </div>
                    <button class="btn-admin" onclick="addChapterFromAdmin()">ADD CHAPTER</button>
                </div>

                <div class="admin-section">
                    <h3>ADD CHARACTER</h3>
                    <div class="form-group">
                        <label>NAME:</label>
                        <input type="text" id="adminCharacterName" placeholder="Enter character name">
                    </div>
                    <div class="form-group">
                        <label>DESCRIPTION:</label>
                        <textarea id="adminCharacterDescription" placeholder="Enter character description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>IMAGE:</label>
                        <input type="file" id="adminCharacterImage" accept="image/*">
                        <img id="adminCharacterImagePreview" class="image-preview" style="display: none;">
                    </div>
                    <button class="btn-admin" onclick="addCharacterFromAdmin()">ADD CHARACTER</button>
                </div>

                <div class="admin-section">
                    <h3>ADD WIKI ITEM</h3>
                    <div class="form-group">
                        <label>TITLE:</label>
                        <input type="text" id="adminWikiTitle" placeholder="Enter wiki title">
                    </div>
                    <div class="form-group">
                        <label>CONTENT:</label>
                        <textarea id="adminWikiContent" placeholder="Enter wiki content"></textarea>
                    </div>
                    <button class="btn-admin" onclick="addWikiItemFromAdmin()">ADD WIKI ITEM</button>
                </div>

                <div class="admin-section">
                    <h3>ADD BOOK</h3>
                    <div class="form-group">
                        <label>NUMBER:</label>
                        <input type="number" id="adminBookNumber" placeholder="Enter book number">
                    </div>
                    <div class="form-group">
                        <label>TITLE:</label>
                        <input type="text" id="adminBookTitle" placeholder="Enter book title">
                    </div>
                    <div class="form-group">
                        <label>DESCRIPTION:</label>
                        <textarea id="adminBookDescription" placeholder="Enter book description"></textarea>
                    </div>
                    <button class="btn-admin" onclick="addBookFromAdmin()">ADD BOOK</button>
                </div>

                <div class="admin-section">
                    <h3>ADD RELEASE DATE</h3>
                    <div class="form-group">
                        <label>DATE:</label>
                        <input type="date" id="adminReleaseDate">
                    </div>
                    <div class="form-group">
                        <label>DESCRIPTION:</label>
                        <input type="text" id="adminReleaseDescription" placeholder="Enter description">
                    </div>
                    <button class="btn-admin" onclick="addReleaseDateFromAdmin()">ADD RELEASE DATE</button>
                </div>

                <div class="admin-section">
                    <h3>MAINTENANCE MODE</h3>
                    <button class="btn-admin btn-admin-danger" onclick="toggleMaintenanceMode()">
                        ${isMaintenanceMode ? 'DISABLE MAINTENANCE' : 'ENABLE MAINTENANCE'}
                    </button>
                </div>
            `;
            
            // Load statistics
            loadStatistics();
        }

        // Update admin color
        function updateAdminColor(variable, value) {
            document.documentElement.style.setProperty(variable, value);
            saveSetting(`color_${variable}`, value);
        }

        // Load statistics
        async function loadStatistics() {
            try {
                // Get visits data
                const visitsDoc = await db.collection('stats').doc('visits').get();
                const chapterViewsDoc = await db.collection('stats').doc('chapter_views').get();
                
                const visitsData = visitsDoc.exists ? visitsDoc.data() : { total: 0, today: 0 };
                const chapterViewsData = chapterViewsDoc.exists ? chapterViewsDoc.data() : { total: 0 };
                
                // Update stats
                document.getElementById('totalVisits').textContent = visitsData.total;
                document.getElementById('visitsToday').textContent = visitsData.today;
                document.getElementById('chapterViews').textContent = chapterViewsData.total;
                document.getElementById('activeUsers').textContent = 0; // Will be updated in real-time
                
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Save setting
        async function saveSetting(key, value) {
            try {
                await db.collection('settings').doc('admin').set({
                    [key]: value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error saving setting:', error);
            }
        }

        // Close all panels
        function closeAllPanels() {
            document.getElementById('chaptersMenu').classList.remove('open');
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        // Authentication Functions
        function checkAdminStatus() {
            auth.onAuthStateChanged(async user => {
                if (user) {
                    isAdmin = true;
                    document.getElementById('adminToggle').classList.add('show');
                    
                    // Store current user
                    currentUser = user;
                    
                    // Update user profile
                    await updateUserProfile(user);
                    
                    // Check maintenance mode
                    checkMaintenanceMode();
                } else {
                    isAdmin = false;
                    document.getElementById('adminToggle').classList.remove('show');
                    currentUser = null;
                }
            });
        }

        async function updateUserProfile(user) {
            try {
                const userRef = db.collection('users').doc(user.uid);
                const doc = await userRef.get();
                
                if (!doc.exists) {
                    // Create new user profile
                    await userRef.set({
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL || null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        rank: 'reader',
                        points: 0,
                        bio: ''
                    });
                } else {
                    // Update existing profile
                    await userRef.update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error updating user profile:', error);
            }
        }

        function login() {
            const email = prompt('Введите email администратора:');
            const password = prompt('Введите пароль:');
            
            if (email && password) {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        alert('Вы вошли как администратор');
                    })
                    .catch(error => {
                        alert('Ошибка входа: ' + error.message);
                    });
            }
        }

        function logout() {
            auth.signOut();
            toggleAdminPanel();
            alert('Вы вышли из системы');
        }

        // Maintenance Mode Functions
        async function checkMaintenanceMode() {
            try {
                const doc = await db.collection('settings').doc('maintenance').get();
                if (doc.exists) {
                    const data = doc.data();
                    isMaintenanceMode = data.enabled || false;
                    updateMaintenanceToggleButton();
                    
                    if (!isAdmin) {
                        if (isMaintenanceMode) {
                            showMaintenanceMode();
                        }
                    }
                }
            } catch (error) {
                console.log('Ошибка проверки режима тех. работ:', error);
            }
        }

        function updateMaintenanceToggleButton() {
            const button = document.getElementById('maintenanceToggleBtn');
            if (button) {
                button.textContent = isMaintenanceMode ? 'Выключить тех. работы' : 'Включить тех. работы';
                button.style.background = isMaintenanceMode ? 
                    'linear-gradient(45deg, #ef4444, #dc2626)' : 
                    'linear-gradient(45deg, var(--primary), var(--secondary))';
            }
        }

        async function toggleMaintenanceMode() {
            if (!isAdmin) return;
            
            try {
                isMaintenanceMode = !isMaintenanceMode;
                
                await db.collection('settings').doc('maintenance').set({
                    enabled: isMaintenanceMode,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: auth.currentUser ? auth.currentUser.uid : null
                }, { merge: true });
                
                updateMaintenanceToggleButton();
                
                if (isMaintenanceMode) {
                    alert('Режим технических работ включен!');
                    showMaintenanceMode();
                } else {
                    alert('Режим технических работ выключен!');
                    hideMaintenanceMode();
                }
            } catch (error) {
                console.error('Ошибка переключения режима тех. работ:', error);
                alert('Ошибка: ' + error.message);
                isMaintenanceMode = !isMaintenanceMode;
                updateMaintenanceToggleButton();
            }
        }

        function showMaintenanceMode() {
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.classList.add('active');
                startTerminalSimulation();
                createMatrixEffect();
                createNeonGrid();
            }
        }

        function hideMaintenanceMode() {
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.classList.remove('active');
            }
        }

        function exitMaintenanceMode() {
            if (!isAdmin) return;
            
            const maintenanceMode = document.getElementById('maintenanceMode');
            if (maintenanceMode) {
                maintenanceMode.classList.remove('active');
            }
            
            const exitBtn = document.getElementById('exitMaintenanceBtn');
            if (exitBtn) {
                exitBtn.style.display = 'block';
            }
        }

        function startTerminalSimulation() {
            const terminalContent = document.getElementById('terminalContent');
            if (!terminalContent) return;
            
            terminalContent.innerHTML = '';
            
            const initialLines = [
                '> Initializing CYBER_TERMINAL v2.1.5...',
                '> System boot sequence initiated',
                '> Loading kernel modules...',
                '> Establishing secure connection...',
                '> Authentication successful',
                '> Welcome, SYSTEM_ADMIN',
                '',
                '> SYSTEM STATUS: MAINTENANCE MODE',
                '> ACCESS TO PUBLIC CONTENT RESTRICTED',
                '> All services temporarily unavailable',
                '',
                '> INITIATING SYSTEM DIAGNOSTICS...',
                ''
            ];
            
            initialLines.forEach(line => {
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.textContent = line;
                terminalContent.appendChild(lineElement);
            });
            
            setInterval(() => {
                const activities = [
                    '[INFO] Running system checks...',
                    '[INFO] Scanning for corrupted files...',
                    '[INFO] Running system checks...',
                    '[DEBUG] Cache cleared successfully',
                    '[WARNING] Disk space low (15% remaining)',
                    '[INFO] System optimization complete',
                    '[WARNING] Memory usage at 87%',
                    '[INFO] Log files archived',
                    '[DEBUG] Module core.dll loaded',
                    '[INFO] Encryption protocols updated',
                    '[INFO] SSL certificates renewed',
                    '[INFO] Firewall status: ACTIVE',
                    '[INFO] Network connectivity stable',
                    '[INFO] Database backup in progress...',
                    '[INFO] Security protocols updated',
                    '[INFO] API endpoints secured',
                    '[INFO] SSL certificates renewed',
                    '[INFO] Core modules initialized',
                    '[INFO] System diagnostics complete',
                    '[INFO] System ready for maintenance'
                ];
                
                const randomActivity = activities[Math.floor(Math.random() * activities.length)];
                const lineElement = document.createElement('div');
                lineElement.className = 'terminal-line';
                lineElement.textContent = '> ' + randomActivity;
                terminalContent.appendChild(lineElement);
                terminalContent.scrollTop = terminalContent.scrollHeight;
            }, 2000);
        }

        function createMatrixEffect() {
            const matrixEffect = document.getElementById('matrixEffect');
            if (!matrixEffect) return;
            
            matrixEffect.innerHTML = '';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&*';
            const fontSize = 14;
            const columns = Math.floor(window.innerWidth / fontSize);
            
            for (let i = 0; i < 100; i++) {
                const char = document.createElement('div');
                char.className = 'matrix-char';
                char.textContent = chars[Math.floor(Math.random() * chars.length)];
                char.style.left = `${Math.random() * 100}%`;
                char.style.top = `${Math.random() * 100}%`;
                char.style.fontSize = `${Math.random() * 10 + 10}px`;
                char.style.opacity = Math.random() * 0.5;
                matrixEffect.appendChild(char);
                
                animateMatrixChar(char);
            }
        }

        function createNeonGrid() {
            const neonGrid = document.querySelector('.neon-grid');
            if (!neonGrid) return;
            
            const interval = setInterval(() => {
                const currentOpacity = parseFloat(getComputedStyle(neonGrid).opacity);
                const newOpacity = currentOpacity === 0.1 ? 0.2 : 0.1;
                neonGrid.style.opacity = newOpacity;
            }, 1000);
            
            neonGrid.addEventListener('remove', () => clearInterval(interval));
        }

        function animateMatrixChar(char) {
            let posY = -20;
            const speed = Math.random() * 2 + 1;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$#@%&*';
            
            function fall() {
                posY += speed;
                char.style.top = `${posY}%`;
                
                if (posY > 100) {
                    posY = -20;
                    char.textContent = chars[Math.floor(Math.random() * chars.length)];
                }
                
                requestAnimationFrame(fall);
            }
            
            fall();
        }

        // Navigation Functions
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionId + 'Section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Show loading indicator
        function showLoading(section) {
            const loadingElement = document.getElementById(`${section}Loading`);
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
        }

        // Hide loading indicator
        function hideLoading(section) {
            const loadingElement = document.getElementById(`${section}Loading`);
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }

        // Show error message
        function showError(section, message) {
            const errorElement = document.getElementById(`${section}Error`) || 
                               document.getElementById('adminError');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        // Modal functions
        function openDeleteModal(message, callback) {
            deleteCallback = callback;
            const messageElement = document.getElementById('deleteMessage');
            if (messageElement) {
                messageElement.textContent = message;
            }
            const modalElement = document.getElementById('deleteModal');
            if (modalElement) {
                modalElement.style.display = 'flex';
            }
        }
        
        function closeDeleteModal() {
            const modalElement = document.getElementById('deleteModal');
            if (modalElement) {
                modalElement.style.display = 'none';
            }
            deleteCallback = null;
        }
        
        function confirmDelete() {
            if (deleteCallback) {
                deleteCallback();
            }
            closeDeleteModal();
        }

        // Image preview
        document.addEventListener('DOMContentLoaded', function() {
            const characterImage = document.getElementById('characterImage');
            if (characterImage) {
                characterImage.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('characterImagePreview');
                            if (preview) {
                                preview.src = e.target.result;
                                preview.style.display = 'block';
                            }
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // CRUD Functions for Chapters
        async function addChapterFromAdmin() {
            if (!isAdmin) return;
            
            const chapterInput = document.getElementById('adminChapterNumber');
            const titleInput = document.getElementById('adminChapterTitle');
            const descriptionInput = document.getElementById('adminChapterDescription');
            const contentInput = document.getElementById('adminChapterContent');
            
            if (!chapterInput || !titleInput || !descriptionInput || !contentInput) {
                showError('admin', 'Ошибка: не найдены поля формы');
                return;
            }
            
            const chapterInputValue = chapterInput.value;
            const title = titleInput.value;
            const description = descriptionInput.value;
            const content = contentInput.value;
            
            if (!chapterInputValue || !title || !content) {
                showError('admin', 'Пожалуйста, заполните все обязательные поля');
                return;
            }
            
            try {
                const chapterData = {
                    title: title,
                    description: description,
                    content: content,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    views: 0
                };
                
                if (chapterInputValue.includes('.')) {
                    chapterData.chapterCode = chapterInputValue;
                } else {
                    chapterData.number = parseInt(chapterInputValue);
                }
                
                await db.collection('chapters').add(chapterData);
                await loadChapters();
                clearForm(['adminChapterNumber', 'adminChapterTitle', 'adminChapterDescription', 'adminChapterContent']);
                
                // Update statistics
                updateStatistic('chapter_count', 1);
                
                alert('Глава успешно добавлена!');
            } catch (error) {
                console.error('Ошибка при добавлении главы:', error);
                showError('admin', 'Ошибка при добавлении главы: ' + error.message);
            }
        }

        async function loadChapters() {
            try {
                showLoading('chapters');
                const snapshot = await db.collection('chapters').get();
                const chapters = [];
                snapshot.forEach(doc => {
                    chapters.push({ id: doc.id, ...doc.data() });
                });
                renderChapters(chapters);
                renderMenuChapters(chapters);
                hideLoading('chapters');
            } catch (error) {
                hideLoading('chapters');
                showError('chapters', 'Ошибка при загрузке глав: ' + error.message);
            }
        }

        function renderChapters(chapters) {
            const container = document.getElementById('chaptersGrid');
            if (!container) return;
            container.innerHTML = '';
            
            chapters.sort((a, b) => {
                const numA = a.chapterCode !== undefined ? 
                    (typeof a.chapterCode === 'string' ? parseFloat(a.chapterCode) : a.chapterCode) : 
                    a.number;
                const numB = b.chapterCode !== undefined ? 
                    (typeof b.chapterCode === 'string' ? parseFloat(b.chapterCode) : b.chapterCode) : 
                    b.number;
                
                if (numA === numB) {
                    return a.id.localeCompare(b.id);
                }
                return numA - numB;
            });

            chapters.forEach(chapter => {
                const chapterNumber = chapter.chapterCode !== undefined ? chapter.chapterCode : chapter.number;
                
                const chapterCard = document.createElement('div');
                chapterCard.className = 'chapter-card';
                chapterCard.onclick = () => showChapter(chapter.id);
                chapterCard.innerHTML = `
                    <div class="chapter-number">Глава ${chapterNumber}</div>
                    <h3 class="chapter-title">${chapter.title || 'Без названия'}</h3>
                    <p class="chapter-description">${chapter.description || ''}</p>
                    ${isAdmin ? `<button class="btn delete-btn" onclick="event.stopPropagation(); deleteChapter('${chapter.id}', '${chapter.title || 'Без названия'}')">Удалить</button>` : ''}
                `;
                container.appendChild(chapterCard);
            });
        }

        function renderMenuChapters(chapters) {
            const container = document.getElementById('menuChaptersList');
            if (!container) return;
            container.innerHTML = '';
            
            chapters.sort((a, b) => {
                const numA = a.chapterCode !== undefined ? 
                    (typeof a.chapterCode === 'string' ? parseFloat(a.chapterCode) : a.chapterCode) : 
                    a.number;
                const numB = b.chapterCode !== undefined ? 
                    (typeof b.chapterCode === 'string' ? parseFloat(b.chapterCode) : b.chapterCode) : 
                    b.number;
                
                return numA - numB;
            });

            chapters.forEach(chapter => {
                const chapterNumber = chapter.chapterCode !== undefined ? chapter.chapterCode : chapter.number;
                
                const chapterCard = document.createElement('div');
                chapterCard.className = 'chapter-menu-card';
                chapterCard.innerHTML = `
                    <div class="chapter-menu-header">
                        <div class="chapter-menu-number">Глава ${chapterNumber}</div>
                    </div>
                    <h3 class="chapter-menu-title">${chapter.title || 'Без названия'}</h3>
                    <p class="chapter-menu-desc">${chapter.description || ''}</p>
                    <a href="#" class="chapter-menu-read-btn" onclick="event.preventDefault(); showChapter('${chapter.id}')">Читать</a>
                `;
                container.appendChild(chapterCard);
            });
        }

        function showChapter(id) {
            window.location.href = `chapter.html?id=${id}`;
            
            // Update chapter view count
            updateChapterView(id);
        }

        async function updateChapterView(chapterId) {
            try {
                await db.collection('chapters').doc(chapterId).update({
                    views: firebase.firestore.FieldValue.increment(1)
                });
                
                // Update global chapter views stat
                updateStatistic('chapter_views', 1);
            } catch (error) {
                console.error('Error updating chapter view:', error);
            }
        }

        async function deleteChapter(chapterId, chapterTitle) {
            if (!isAdmin) return;
            
            openDeleteModal(`Вы уверены, что хотите удалить главу "${chapterTitle}"?`, async () => {
                try {
                    await db.collection('chapters').doc(chapterId).delete();
                    await loadChapters();
                    alert('Глава успешно удалена!');
                } catch (error) {
                    showError('admin', 'Ошибка при удалении главы: ' + error.message);
                }
            });
        }

        // Update statistic
        async function updateStatistic(statName, increment = 1) {
            try {
                await db.collection('stats').doc('visits').set({
                    [statName]: firebase.firestore.FieldValue.increment(increment),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Reload statistics if admin panel is open
                if (document.getElementById('adminPanel').classList.contains('active')) {
                    loadStatistics();
                }
            } catch (error) {
                console.error('Error updating statistic:', error);
            }
        }

        // Messenger Functions
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput || !messageInput.value.trim()) return;
            
            if (!currentUser) {
                alert('Пожалуйста, войдите в систему для отправки сообщений');
                return;
            }
            
            const message = messageInput.value.trim();
            
            try {
                await db.collection('messages').add({
                    text: message,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    userPhoto: currentUser.photoURL,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0
                });
                
                messageInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Ошибка отправки сообщения');
            }
        }

        // Load messages
        function loadMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            // Listen for new messages
            db.collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    messagesContainer.innerHTML = '';
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            const messageElement = createMessageElement(message);
                            messagesContainer.prepend(messageElement);
                        }
                    });
                });
        }

        function createMessageElement(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            const now = new Date();
            const timeDiff = (now - message.timestamp.toDate()) / 1000;
            let timeString;
            
            if (timeDiff < 60) {
                timeString = 'только что';
            } else if (timeDiff < 3600) {
                timeString = `${Math.floor(timeDiff / 60)} мин назад`;
            } else if (timeDiff < 86400) {
                timeString = `${Math.floor(timeDiff / 3600)} ч назад`;
            } else {
                timeString = message.timestamp.toDate().toLocaleDateString();
            }
            
            messageElement.innerHTML = `
                <div class="message-user">${message.userName}</div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            return messageElement;
        }

        // Clear form fields
        function clearForm(fields) {
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadChapters(),
                loadCharacters(),
                loadWiki(),
                loadBooks(),
                loadSchedule()
            ]);
            
            // Load messenger
            loadMessages();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            createStars();
            
            // Hide loading overlay after 3 seconds
            setTimeout(() => {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }, 3000);
            
            // Check admin status
            checkAdminStatus();
            
            // Check maintenance mode
            checkMaintenanceMode();
            
            // Load all data
            loadAllData();
            
            // Show initial section
            showSection('chapters');
        });
    </script>
</body>
</html>
