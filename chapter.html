<script>
    // Firebase Configuration (замените на вашу конфигурацию)
    const firebaseConfig = {
        apiKey: "AIzaSyCLuEVA6AYJereNnGnxDC8lqjCDmvGfqwc",
        authDomain: "heart-of-efir.firebaseapp.com",
        projectId: "heart-of-efir",
        storageBucket: heart-of-efir.firebasestorage.app",
        messagingSenderId: "296902937897",
        appId: "1:296902937897:web:11de57e0de55eb84a63b38"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Enable offline persistence
    db.enablePersistence({ synchronizeTabs: true })
        .catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Multiple tabs open, persistence can only be enabled in one tab at a a time.');
            } else if (err.code == 'unimplemented') {
                console.log('The current browser does not support all of the features required to enable persistence');
            }
        });

    // Get chapter ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const chapterId = urlParams.get('id');

    if (chapterId) {
        loadChapter(chapterId);
    } else {
        hideLoading('Глава не найдена');
    }

    async function loadChapter(id) {
        try {
            console.log('Loading chapter with ID:', id);
            
            // Попробуем сначала загрузить из кэша, затем из сети
            const doc = await db.collection('chapters').doc(id).get({ source: 'server' });
            
            if (doc.exists) {
                const chapter = doc.data();
                console.log('Chapter data:', chapter);
                
                document.getElementById('chapterTitle').textContent = `Глава ${chapter.number}: ${chapter.title}`;
                document.getElementById('chapterText').innerHTML = chapter.content.replace(/\n/g, '<br>');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chapterContent').style.display = 'block';
            } else {
                hideLoading('Глава не найдена в базе данных');
            }
        } catch (error) {
            console.error('Error loading chapter:', error);
            
            // Попробуем загрузить из кэша
            try {
                const doc = await db.collection('chapters').doc(id).get({ source: 'cache' });
                if (doc.exists) {
                    const chapter = doc.data();
                    document.getElementById('chapterTitle').textContent = `Глава ${chapter.number}: ${chapter.title}`;
                    document.getElementById('chapterText').innerHTML = chapter.content.replace(/\n/g, '<br>');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('chapterContent').style.display = 'block';
                } else {
                    hideLoading('Ошибка загрузки главы. Проверьте подключение к интернету.');
                }
            } catch (cacheError) {
                hideLoading('Ошибка загрузки главы. Проверьте подключение к интернету.');
            }
        }
    }

    function hideLoading(message) {
        document.getElementById('loading').innerHTML = `<p>${message}</p>`;
    }
</script>
